---
title: "School Maps PDFs"
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---


# Input Data & Configuration

## Libraries
```{r libs, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
date()
library(tidyverse)
library(ggmap)
library(sf)
library(osrm)
library(smoothr)
library(ggnewscale)
library(RColorBrewer)
library(magick)
library(rsvg)
library(furrr)
```

## Load school data
```{r schooldata, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
## load school locations
WI_schools <- st_read(dsn = "data/Schools/Wisconsin_Public_Schools_1685606960273492878.gpkg")

## Set crs
WI_schools <- WI_schools |> 
  st_transform(crs = 4326)

## Filter out virtual schools
WI_schools <- WI_schools |>
  filter_out(
    when_any(
      VIRTUAL == "Yes",
      is.na(LAT),
      is.na(LON),
      is.na(NCES_CODE)
      )
    )

# Manually override some walk boundaries
district_walk_policies <- tribble(
  ~name, ~hs,  ~ms,  ~es,
  "Madison Metropolitan", 1.5, 1.5, 1.5,
  "Milwaukee", 2.0, 2.0, 1.0
)
```

## Set parameters of run
```{r runparameters, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
run_parameters <- read_csv(file = "parameters/run_parameters.csv")
# set which counties to generate figures for
county_focus <- run_parameters$county_focus
if(str_to_lower(county_focus) == "all") {
  county_focus <- str_to_upper(unique(WI_schools |> pull(COUNTY)))
}

# set which school types to generate figures for
school_type_focus <- run_parameters$school_type_focus
if(str_to_lower(school_type_focus) == "all") {
  school_type_focus <- unique(WI_schools |> pull(SCHOOLTYPE))
}

# set which school types to generate figures for
district_focus <- run_parameters$district_focus
if(str_to_lower(district_focus) == "all") {
  district_focus <- WI_schools |> 
    filter(str_to_upper(COUNTY) %in% str_to_upper(county_focus)) |> 
    pull(DISTRICT) |> 
    unique()
} else {
  district_focus <- WI_schools |> 
    filter(str_to_upper(COUNTY) %in% str_to_upper(county_focus),
           str_to_upper(DISTRICT) %in% str_to_upper(district_focus)) |> 
    pull(DISTRICT) |> 
    unique()
}

# Filter WI_schools
WI_schools <- WI_schools |> 
  filter(
    str_to_upper(DISTRICT) %in% str_to_upper(district_focus),
    str_to_upper(SCHOOLTYPE) %in% str_to_upper(school_type_focus),
    str_to_upper(COUNTY) %in% str_to_upper(county_focus)
         )

school_number <- length(unique(WI_schools |>  
                          pull(NCES_CODE)))

# Set run parameters as a number
run_parameters$parallel_workers <- as.numeric(run_parameters$parallel_workers)

```

## Load TOPS data
```{r loadTOPS, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
load(file = "data/TOPS/TOPS_data.Rda")
load(file = "data/TOPS/vuln_roles.Rda")
load(file = "data/TOPS/retrieve_date.Rda")
load(file = "data/TOPS/injury_severity.Rda")
```

## Make TOPS data type sf
```{r sfTOPS, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
TOPS_data_sf <- TOPS_data |> 
  filter_out(is.na(longitude),
             is.na(latitude)) |> 
  st_as_sf(coords = c("longitude", "latitude"),
           crs = 4326)
```

## Load bike LTS networks (if specified in run_parameters.csv)
```{r bikeLTS, eval = run_parameters$bike_lts, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
bike_lts <- list()
for(file in list.files("data/bike_lts")) {
  county <- str_sub(file, 10, -9) |> 
    str_to_lower()
  lts_run <- st_read(paste0("data/bike_lts/", file)) |> 
    st_transform(crs = 4326)
  lts_run[["lts"]] <- as.factor(lts_run$LTS_F)
  bike_lts[[county]] <- lts_run
}
rm(lts_run)
bike_lts_scale <- data.frame(code = c(1, 2, 3, 4, 9),
                             color = c("#1a9641",
                                       "#a6d96a",
                                       "#fdae61",
                                       "#d7191c",
                                       "#d7191c"))
```

## Load API keys from StadiaMaps and the census
```{r APIkeys, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
# register stadia API key ----
register_stadiamaps(key = substr(read_file(file = "api_keys/stadia_api_key"), 1, 36))

# load census api key ----
#census_api_key(key = substr(read_file(file = "api_keys/census_api_key"), 1, 40))
```

## Load logos
```{r logos, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}
bikefed_logo_file <- "icons/BWF_Vertical_4C.svg"
school_symbol_file <- "icons/school_FILL0_wght400_GRAD0_opsz24.svg"

bikefed_logo <- image_read_svg(path = bikefed_logo_file)
school_symbol <- image_read_svg(path = school_symbol_file)
```

## generate county charts
```{r countyfigures, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}

for(county in county_focus) {
  message(county)
  TOPS_data |> 
    filter(CNTYNAME %in% county) |> 
    filter(ROLE1 %in% vuln_roles & age1 < 18 | ROLE2 %in% vuln_roles & age2 < 18) |> 
    group_by(year, ped_inj_name) |> 
    summarise(count = n_distinct(DOCTNMBR)) |>
    ungroup() |> 
    complete(year, ped_inj_name, fill = list(count = 0)) |>
    filter(ped_inj_name %in% c("Suspected Minor Injury", "Suspected Serious Injury", "Fatality")) |>
    ggplot() +
    geom_col(aes(x = year,
                 y = count,
                 fill = ped_inj_name)) +
    scale_fill_manual(values = setNames(injury_severity$color, injury_severity$InjSevName), name = "Injury Severity") +
    scale_y_continuous(expand = expansion(mult = c(0,0.07)), breaks = scales::pretty_breaks(min.n = 0)) +
    theme(plot.caption = element_text(color = "grey")) +
    labs(title = paste0("Pedestrians/bicyclists under 18 years old killed or injured by drivers in ",
                        str_to_title(county), 
                        " County"),
         x = "Year",
         y = "Number of crashes",
         caption = paste0("crash data from UW TOPS lab - retrieved ",
                          strftime(retrieve_date, format = "%m/%Y"),
                          " per direction of the WisDOT Bureau of Transportation Safety",
                          "\nbasemap from StadiaMaps and OpenStreetMap Contributers"))
  ggsave(file = paste0("figures/school_maps/Crash Maps/", 
                       str_to_title(county), 
                       " County/_",
                       str_to_title(county), 
                       " County_year.pdf"), 
         title = paste0(county, " County Youth Pedestrian/Bike crashes"),
         device = pdf,
         height = 8.5,
         width = 11,
         units = "in",
         create.dir = TRUE)
}
```

# Generate school maps

## Set OpenStreetMap Routing Machine parameters
```{r OSRM, eval = TRUE, echo = TRUE, results = "show", warning = FALSE, error = TRUE, message = FALSE}

options(osrm.server = "http://127.0.0.1:5000/")
options(osrm.profile = "walk")
```

## Functions to generate maps
```{r schoolMaps, eval = TRUE, echo = TRUE, results = "show", warning = NA, error = TRUE, message = NA}
# calculates the width and height lat/lon for a given school
get_logo_bounds <- function(center_lon, center_lat, height_meters, image) {
  # Get image aspect ratio
  img_aspect <- image_info(image)$width / image_info(image)$height
  
  # Convert height from meters to degrees of latitude
  height_deg <- height_meters / 111320
  
  # Calculate width in degrees
  width_deg <- (height_deg * img_aspect) / cos(center_lat * pi / 180)
  
  list(
    xmin = center_lon - width_deg / 2,
    xmax = center_lon + width_deg / 2,
    ymin = center_lat - height_deg / 2,
    ymax = center_lat + height_deg / 2
  )
}

generate_school_maps <- function(district) {
  
  # Load logos (for furrr)
  bikefed_logo <- image_read_svg(path = bikefed_logo_file)
  school_symbol <- image_read_svg(path = school_symbol_file)
  
  message(paste("***", district, "School District |"))
  options(ggmap.file_drawer = paste0("basemaps/districts/", district))
  if(file.exists(paste0("basemaps/districts/", district, "/index.rds")) & !run_parameters$refresh_basemaps) {
    readRDS(file_drawer("index.rds"))
  } else {
    dir.create(file_drawer(), recursive = TRUE, showWarnings = FALSE)
    saveRDS(list(), file_drawer("index.rds"))
  }
  file_drawer("index.rds")
  for(school in WI_schools |>
      filter(str_to_upper(DISTRICT) %in% str_to_upper(district)) |>
      pull(NCES_CODE)) {
    school_data <- WI_schools |> filter(NCES_CODE == school)
    message(paste(school_data |> pull(SCHOOL), "-", 
                  district, "School District", "-", 
                  school_data |> pull(COUNTY), "County")
            )

    # Set default walk boundary to 2 miles (per DPI)
    walk_boundary_mi <- 2.0
    
    # Override default if specified in district_walk_policies
    current_school_type <- school_data |> pull(SCHOOLTYPE)
    target_district <- district_walk_policies |> filter(name == district)
    
    if (nrow(target_district) > 0) {
      walk_boundary_mi <- case_when(
        current_school_type %in% "High School" ~ target_district$hs,
        current_school_type %in% c("Junior High School", "Middle School") ~ target_district$ms,
        current_school_type %in% c("Combined Elementary/Secondary School", 
                                   "Elementary School") ~ target_district$es,
        TRUE ~ 2.0 # For any other school types
      )
    }
    # Convert miles to meters
    walk_boundary_m <- walk_boundary_mi * 1609

    # Query OSRM for the walk_boundary_poly    
    walk_boundary_poly <- osrmIsodistance(
      loc = school_data |> pull(SHAPE),
      breaks = c(walk_boundary_m),
      n = 2000) |> 
      st_make_valid() |> 
      fill_holes(units::set_units(1, "km^2"))
    
    # create bounding box from school, 500m outside walk boundary.
    bbox <- school_data |> 
      pull(SHAPE) |> 
      st_buffer(dist = walk_boundary_m + 500) |> 
      st_bbox()
    bbox_list <- c(left = as.double(bbox[1]), 
                     bottom = as.double(bbox[2]), 
                     right = as.double(bbox[3]), 
                     top = as.double(bbox[4]))
    
    #get basemap
    basemap <- get_stadiamap(bbox = bbox_list, 
                             zoom = 15, 
                             maptype = "stamen_toner_lite")
    
    # Get square bounds for logos
    # School logo
    school_bounds <- get_logo_bounds(
      as.double((school_data |> pull(SHAPE))[[1]])[1],
      as.double((school_data |> pull(SHAPE))[[1]])[2],
      300,
      school_symbol
      )
    # Bike Fed logo
    # Adjustable parameters
    # Logo height as % of map height
    logo_height_pct <- 0.16
    # Gap between right map edge and logo
    offset_from_right_pct <- 0.05
    
    # Convert to meters
    logo_height_deg <- ((bbox['top'] - bbox['bottom']) * logo_height_pct)
    logo_height_meters <- logo_height_deg * 111320

    # Calculate center latitude
    logo_center_lat <- bbox['top'] - (bbox['top'] - bbox['bottom']) * (logo_height_pct / 2)
    
    # Calculate the logo width in degrees
    logo_width_deg <- logo_height_deg / cos(logo_center_lat * pi / 180)
    
    # Calculate center longitude: right edge + offset + half the logo width
    logo_center_lon <- bbox['right'] + (bbox['right'] - bbox['left']) * offset_from_right_pct + logo_width_deg / 2
    
    # Get square bounds
    bikefed_bounds <- get_logo_bounds(
      logo_center_lon, 
      logo_center_lat, 
      logo_height_meters,
      bikefed_logo)
    
    # generate map
    school_map <- ggmap(basemap)
    
    ## add bike lts if set in run_parameters and available for the county
    if(run_parameters$bike_lts == TRUE &&
       !is.null(bike_lts[[county]])){
      school_map <- school_map +
        geom_sf(data = bike_lts[[school_data |> pull(COUNTY) |> str_to_lower()]] |> 
                  st_crop(bbox),
                inherit.aes = FALSE,
                aes(color = lts)) +
        scale_color_manual(values = bike_lts_scale$color, name = "Bike Level of Traffic Stress") +
        new_scale_color()
    }
    
    school_map <- school_map +
      labs(title = paste0(
        "Crashes between cars and youth (<18) pedestrians/bicyclists near ",
        #        "Crashes between cars and all pedestrians/bicyclists near ",
        school_data |> pull(SCHOOL)
        ),
        subtitle = paste0(school_data |> pull(DISTRICT),
                          " School District | ",
                          min(year(TOPS_data$date), na.rm = TRUE), 
                          " - ", 
                          max(year(TOPS_data$date), na.rm = TRUE)),
        caption = paste0("Crash data from UW TOPS lab - retrieved ",
                         strftime(retrieve_date, format = "%m/%Y"),
                         " per direction of the WisDOT Bureau of Transportation Safety",
                         "\nBasemap from StadiaMaps and OpenStreetMap Contributers"),
        x = NULL,
        y = NULL) +
      theme(axis.text=element_blank(),
            axis.ticks=element_blank(),
            plot.caption = element_text(color = "grey")) +
      
      # add walk boundary
      geom_sf(data = walk_boundary_poly,
              inherit.aes = FALSE,
              aes(color = paste0(walk_boundary_mi, " mile walking boundary")),
              fill = NA,
              linewidth = 1) +
      scale_color_manual(values = "black", name = NULL) +
      
      # add school location
      annotation_raster(school_symbol,
                        ymin = school_bounds$ymin,
                        ymax = school_bounds$ymax,
                        xmin = school_bounds$xmin,
                        xmax = school_bounds$xmax) +
      geom_sf_label(data = school_data,
                    inherit.aes = FALSE,
                    mapping = aes(label = SCHOOL),
                    nudge_y = 0.0015,
                    linewidth = 0.04,
                    size = 2) +
      # Add Bike Fed logo in top right
      annotation_raster(bikefed_logo,
                        ymin = bikefed_bounds$ymin,
                        ymax = bikefed_bounds$ymax,
                        xmin = bikefed_bounds$xmin,
                        xmax = bikefed_bounds$xmax
                        ) +
      coord_sf(clip = "off") +
      # add crash locations
      new_scale_fill() +
      geom_sf(data = TOPS_data_sf |>
                st_filter(st_as_sfc(bbox)) |> 
                   filter(ROLE1 %in% c("BIKE", "PED") 
                          & age1 < 18 
                          | ROLE2 %in% c("BIKE", "PED") 
                          & age2 < 18
                          ) |>
                   arrange(ped_inj_name),
              inherit.aes = FALSE,
              aes(fill = ped_inj_name),
              shape = 23,
              size = 3,
              alpha = 0.8) +
      scale_fill_manual(values = setNames(injury_severity$color, injury_severity$InjSevName), name = "Crash Severity")
    
    # Save map
    ggsave(school_map,
           file = paste0("figures/school_maps/Crash Maps/",
                         str_to_title(school_data |> pull(COUNTY)), 
                         " County/",
                         school_data |> pull(DISTRICT), 
                         " School District/",
                         str_replace_all(school_data |> pull(SCHOOLTYPE), "/","-"), 
                         "s/",
                         str_replace_all(school_data |> pull(SCHOOL), "/", "-"), 
                        # "_all.pdf"),
                        ".pdf"),
           title = paste0(school_data |> pull(SCHOOL), " Youth Pedestrian/Bike crashes"),
           #title = paste0(school_data |> pull(SCHOOL), " All Pedestrian/Bike crashes"),
           device = pdf,
           height = 8.5,
           width = 11,
           units = "in",
           create.dir = TRUE)
  }
}
```

## Generate the school maps
```{r generateMaps, eval = TRUE, echo = TRUE, results = "show", warning = NA, error = TRUE, message = FALSE}
# Define the plan (parallel vs sequential)
if (run_parameters$parallel_workers > 1) {
  plan(multicore, workers = run_parameters$parallel_workers)
} else {
  plan(sequential)
}

# Generate the maps
future_walk(district_focus, 
            generate_school_maps, 
            .progress = TRUE,
            .options = furrr_options(seed = TRUE))
```

# Check that all schools have a map PDF
```{r checkMaps, eval = TRUE, echo = TRUE, results = "show", warning = NA, error = TRUE, message = NA}
# double check that all schools have a map ----
double_check <- list()
for(school in WI_schools |> pull(NCES_CODE)) {
  school_data <- WI_schools |> filter(NCES_CODE %in% school)
  school_check <- data.frame(NCES_CODE = c(school),
                             exists = c(file.exists(paste0("figures/school_maps/Crash Maps/",
                                                           str_to_title(school_data |> pull(COUNTY)), 
                                                           " County/",
                                                           school_data |> pull(DISTRICT), 
                                                           " School District/",
                                                           str_replace_all(school_data |> pull(SCHOOLTYPE), "/","-"), 
                                                           "s/",
                                                           str_replace_all(school_data |> pull(SCHOOL), "/", "-"), 
                                                           #".pdf"))))
                                                           ".pdf"))))
  double_check[[school]] <- school_check
}
double_check <- bind_rows(double_check)
write_csv(double_check, file = "parameters/double_check.csv")

districts_not_done <- data.frame(districts = c(unique(WI_schools |> 
         filter(NCES_CODE %in% (double_check |> 
                                        filter(exists == FALSE) |> 
                                        pull(NCES_CODE)),
                !st_is_empty(SHAPE)) |> 
         pull(DISTRICT))))
write_csv(districts_not_done, file = "parameters/districts_not_done.csv")
```